/*! TBB CC History mini add-on (c) thebukitbesi.com */
!function(w,d){"use strict";
function $(s,r){return (r||d).querySelector(s)}
function draw(canvas,pts){var ctx=canvas.getContext('2d'),W=canvas.width=canvas.clientWidth,H=canvas.height=canvas.clientHeight; ctx.clearRect(0,0,W,H); if(!pts.length)return; var min=Math.min.apply(null,pts),max=Math.max.apply(null,pts),pad=6; var xstep=W/Math.max(1,pts.length-1); ctx.beginPath(); pts.forEach(function(v,i){var x=i*xstep, y=H-pad-( (v-min)/(max-min||1) )*(H-2*pad); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y)}); ctx.lineWidth=2; ctx.strokeStyle=getComputedStyle(canvas).color; ctx.stroke(); }
async function series(from,to){ var end=new Date(), start=new Date(end.getTime()-29*864e5); var s=start.toISOString().slice(0,10), e=end.toISOString().slice(0,10);
  var url="https://api.frankfurter.dev/"+s+".."+e+"?from="+encodeURIComponent(from)+"&to="+encodeURIComponent(to);
  var r=await fetch(url,{mode:'cors',cache:'no-store'}); if(!r.ok) throw 0; var j=await r.json(); var keys=Object.keys(j.rates||{}).sort(); return keys.map(k=>j.rates[k][to]); }
function attach(root){
  var btn=$('.tbbx-history-btn',root), cv=$('.tbbx-spark',root), info=$('.tbbx-rateinfo',root);
  if(!btn||!cv) return;
  btn.addEventListener('click',async function(){
    btn.disabled=true; var pair=root.tbbx_pair||{}; try{
      var pts=await series(pair.from||'USD', pair.to||'MYR'); draw(cv,pts); info && (info.textContent=info.textContent.replace(/$/, " â€¢ 30d view")); 
    }catch(_){ /* ignore */ } finally { btn.disabled=false; }
  },{passive:true});
}
function boot(){ document.querySelectorAll('.tbbx-cc-wrap').forEach(attach) }
if('requestIdleCallback'in w){ w.requestIdleCallback(boot,{timeout:1500}) } else { w.addEventListener('DOMContentLoaded',boot,{once:true}) }
}(window,document);
