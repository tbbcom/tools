/*! TBB Currency Converter â€” (c) thebukitbesi.com â€” single-owner build. License: MIT.
   Domain-lock prevents casual reuse. Serious protection requires server controls. */
!function(w,d){"use strict";var ALLOW=["thebukitbesi.com","localhost","127.0.0.1"],DOMAIN_LOCK=true,TTL=36e5,LS="tbbx_cc_cache_v1",LSFAV="tbbx_cc_favs",LSLANG="tbbx_lang";
function okHost(){if(!DOMAIN_LOCK) return true;var h=(w.location&&w.location.hostname||"").toLowerCase().replace(/^www\./,"");for(var i=0;i<ALLOW.length;i++){var dom=ALLOW[i].toLowerCase();if(h===dom||h.endsWith("."+dom)) return true}console.warn("TBB CC: domain blocked:",h);return false}
function $(s,r){return (r||d).querySelector(s)} function $$(s,r){return Array.from((r||d).querySelectorAll(s))}
function esc(s){return String(s).replace(/[&<>"']/g,function(m){return({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m])})}
function rcache(){try{return JSON.parse(localStorage.getItem(LS)||"{}")}catch(e){return{}}}
function wcache(o){try{localStorage.setItem(LS,JSON.stringify(o))}catch(e){}}
function getFavs(){try{return JSON.parse(localStorage.getItem(LSFAV)||"[]")}catch(e){return[]}}
function setFavs(a){try{localStorage.setItem(LSFAV,JSON.stringify(a))}catch(e){}}
function setLang(v){try{localStorage.setItem(LSLANG,v)}catch(e){}}
function getLang(def){try{return localStorage.getItem(LSLANG)||def}catch(e){return def}}

var MINOR={BHD:3,KWD:3,OMR:3,TND:3,JOD:3,LYD:3,IQD:3,JPY:0,KRW:0,VND:0,CLP:0,PYG:0,RWF:0,UGX:0,XAF:0,XOF:0,XPF:0,MGA:0,MRO:0,MRU:2,DEFAULT:2};
function minor(c){return (MINOR[c]!=null?MINOR[c]:MINOR.DEFAULT)}
function fmt(n,c){var d=minor(c);return Number(n).toLocaleString(void 0,{maximumFractionDigits:d,minimumFractionDigits:0})}
function precise(n,c){var d=minor(c);return Number(n).toFixed(Math.min(6,Math.max(d,2)))}

var I18N={en:{title:"ðŸ’± TBB Currency Converter â€” Fast, Accurate, Ad-Free",amount:"Amount",from:"From",to:"To",convert:"Convert",swap:"Swap",quick:"Quick:",options:"Options",provider:"Provider",prov_host:"exchangerate.host",prov_frank:"Frankfurter (ECB)",prov_auto:"Auto (Best)",cache:"Cache rates in this browser",invert:"Show inverse rate",help:"Client-side only. ISO-accurate rounding. No tracking.",copy:"Copy",share:"Share",copied:"Copied!",copyfail:"Copy failed",link:"Link copied!",converting:"Convertingâ€¦",unavail:"Rate unavailable. Try other provider.",favs:"Favorites:",addfav:"Add Pair",history:"30d chart"},ms:{title:"ðŸ’± Penukar Mata Wang TBB â€” Pantas, Tepat, Tanpa Iklan",amount:"Amaun",from:"Dari",to:"Ke",convert:"Tukar",swap:"Tukar Arah",quick:"Pantas:",options:"Tetapan",provider:"Penyedia",prov_host:"exchangerate.host",prov_frank:"Frankfurter (ECB)",prov_auto:"Auto (Terbaik)",cache:"Cache kadar dalam pelayar ini",invert:"Tunjuk kadar songsang",help:"100% sisi-klien. Pembundaran ISO tepat. Tiada penjejakan.",copy:"Salin",share:"Kongsi",copied:"Disalin!",copyfail:"Salin gagal",link:"Pautan disalin!",converting:"Menukarâ€¦",unavail:"Kadar tidak tersedia. Cuba penyedia lain.",favs:"Kegemaran:",addfav:"Pin Pasangan",history:"Carta 30 hari"}};

var providers={host:{symbols:"https://api.exchangerate.host/symbols",rate:function(f,t){return "https://api.exchangerate.host/convert?from="+encodeURIComponent(f)+"&to="+encodeURIComponent(t)}},frank:{symbols:"https://api.frankfurter.dev/currencies",rate:function(f,t){return "https://api.frankfurter.dev/latest?from="+encodeURIComponent(f)+"&to="+encodeURIComponent(t)}}};
var EMBED={base:"USD",date:"2025-01-01",rates:{MYR:4.2,SGD:1.34,EUR:0.9,IDR:15500,JPY:155,GBP:0.78}};

function initAll(){ if(!okHost()) return; $$('.tbbx-cc-wrap[data-ready!="1"]').forEach(initWidget) }
async function initWidget(root){
  root.setAttribute('data-ready','1');
  var userLang=(root.getAttribute('data-lang')||'en').toLowerCase();
  var lang=getLang(userLang), L=I18N[lang]||I18N.en;
  // Head
  var head=$('.tbbx-cc-head',root); if(!head){ head=d.createElement('div'); head.className='tbbx-cc-head'; head.innerHTML='<h2 class="tbbx-cc-title">'+esc(L.title)+'</h2><div class="tbbx-lang"><button type="button" data-lang="en" aria-pressed="'+(lang==='en')+'">EN</button><button type="button" data-lang="ms" aria-pressed="'+(lang==='ms')+'">BM</button></div>'; root.prepend(head); }
  else $('.tbbx-cc-title',root).textContent=L.title;
  $$('.tbbx-lang button',head).forEach(function(b){ b.addEventListener('click',function(){ var v=b.getAttribute('data-lang'); setLang(v); $$('.tbbx-lang button',head).forEach(function(bb){bb.setAttribute('aria-pressed', String(bb===b))}); localize(root,v); convert(); },{passive:true}) });

  // Labels
  localize(root,lang);

  // Fill selects
  var from=$('.tbbx-from',root), to=$('.tbbx-to',root), amt=$('.tbbx-amt',root);
  var symbols=await loadSymbols(['host','frank']);
  fillSelect(from,symbols,['MYR','USD','SGD','EUR','JPY']); fillSelect(to,symbols,['USD','MYR','SGD','EUR','JPY']);
  if(lang==='ms'){from.value='MYR';to.value='USD';} else {from.value='USD';to.value='MYR';}
  if(amt) amt.value='100';

  // Events
  $('.tbbx-convert',root).addEventListener('click',convert,{passive:true});
  $('.tbbx-swap',root).addEventListener('click',swap,{passive:true});
  [from,to].forEach(function(el){el.addEventListener('change',convert,{passive:true})});
  amt.addEventListener('keydown',function(e){if(e.key==='Enter'){e.preventDefault();convert()}},{passive:false});
  $$('.tbbx-chip',root).forEach(function(ch){ch.addEventListener('click',function(){amt.value=ch.getAttribute('data-amt');convert()},{passive:true})});
  $('.tbbx-provider',root).addEventListener('change',function(){localStorage.setItem('tbbx_provider',this.value);convert()},{passive:true});
  $('.tbbx-invert',root).addEventListener('change',convert,{passive:true});
  $('.tbbx-copy',root).addEventListener('click',copyRes,{passive:true});
  $('.tbbx-share',root).addEventListener('click',shareRes,{passive:true});
  $('.tbbx-addfav',root).addEventListener('click',addFav,{passive:true});
  renderFavs();

  // Defer first run
  if('requestIdleCallback'in w){w.requestIdleCallback(convert,{timeout:1200})} else {setTimeout(convert,0)}

  async function loadSymbols(order){
    for(var i=0;i<order.length;i++){
      try{
        if(order[i]==='host'){ var h=await j(providers.host.symbols); var list=Object.keys(h.symbols||{}).map(function(c){return{code:c,name:h.symbols[c].description}}); if(list.length) return list; }
        else { var f=await j(providers.frank.symbols); var list2=Object.keys(f||{}).map(function(c){return{code:c,name:f[c]}}); if(list2.length) return list2; }
      }catch(_){}
    }
    return [{code:'USD',name:'US Dollar'},{code:'MYR',name:'Malaysian Ringgit'},{code:'SGD',name:'Singapore Dollar'},{code:'EUR',name:'Euro'},{code:'JPY',name:'Japanese Yen'}];
  }
  function fillSelect(el,list,pref){ var a=list.filter(x=>(pref||[]).includes(x.code)); var b=list.filter(x=>!(pref||[]).includes(x.code)).sort((m,n)=>m.code.localeCompare(n.code)); el.innerHTML=[].concat(a,b).map(c=>'<option value="'+c.code+'">'+c.code+' â€” '+esc(c.name)+'</option>').join('') }
  async function j(url){ var r=await fetch(url,{mode:'cors',cache:'no-store'}); if(!r.ok) throw 0; return await r.json() }

  async function getRate(f,t,pref){
    var now=Date.now(), key=(pref||'auto')+':'+f+'->'+t, C=rcache();
    if($('.tbbx-cache',root).checked && C[key] && (now-C[key].ts)<TTL) return {rate:C[key].rate,date:C[key].date,provider:C[key].provider,cached:true};
    var order=(pref==='host')?['host']:(pref==='frank')?['frank']:['host','frank'];
    for(var i=0;i<order.length;i++){
      try{
        if(order[i]==='host'){ var h=await j(providers.host.rate(f,t)); var r=Number(h.result); if(!isFinite(r)||r<=0) throw 0; var dt=(h.date||'').slice(0,10); if($('.tbbx-cache',root).checked){C[key]={rate:r,date:dt,provider:'host',ts:now}; wcache(C)}; return {rate:r,date:dt,provider:'host',cached:false}; }
        else { var f=await j(providers.frank.rate(f,t)); var r2=Number(f.rates?.[t]); if(!isFinite(r2)||r2<=0) throw 0; var dt2=(f.date||'').slice(0,10); if($('.tbbx-cache',root).checked){C[key]={rate:r2,date:dt2,provider:'frank',ts:now}; wcache(C)}; return {rate:r2,date:dt2,provider:'frank',cached:false}; }
      }catch(_){}
    }
    var base=EMBED.base, rr=1;
    if(f===t) rr=1; else if(f===base&&EMBED.rates[t]) rr=EMBED.rates[t]; else if(t===base&&EMBED.rates[f]) rr=1/EMBED.rates[f]; else if(EMBED.rates[f]&&EMBED.rates[t]) rr=EMBED.rates[t]/EMBED.rates[f];
    if(!isFinite(rr)) throw 0; return {rate:rr,date:EMBED.date,provider:'embedded',cached:true};
  }

  async function convert(){
    var amtEl=$('.tbbx-amt',root), from=$('.tbbx-from',root), to=$('.tbbx-to',root), out=$('.tbbx-out',root), ri=$('.tbbx-rateinfo',root);
    var L=I18N[getLang('en')]||I18N.en; out.textContent=L.converting;
    try{
      var v=Math.max(0,Number(amtEl.value||0)), f=from.value, t=to.value; if(!isFinite(v)) return;
      var pref=$('.tbbx-provider',root).value||'auto'; var g=await getRate(f,t,pref); var inv=$('.tbbx-invert',root).checked?(1/g.rate):g.rate; var res=v*inv;
      out.textContent=fmt(v,f)+' '+f+' = '+fmt(res,t)+' '+t; ri.textContent='Rate: 1 '+f+' = '+precise(inv,t)+' '+t+' ('+g.provider+(g.cached?' â€¢ cached':'')+' â€¢ '+(g.date||'today')+')'; out.setAttribute('data-raw',String(res));
      // expose for chart add-on
      root.tbbx_pair={from:f,to:t,rate:inv,date:g.date};
    }catch(_){ out.textContent=(I18N[getLang('en')]||I18N.en).unavail; $('.tbbx-rateinfo',root).textContent='' }
  }
  function swap(){ var a=$('.tbbx-from',root).value; $('.tbbx-from',root).value=$('.tbbx-to',root).value; $('.tbbx-to',root).value=a; convert() }
  async function copyRes(){ try{ await navigator.clipboard.writeText($('.tbbx-out',root).textContent+' ('+$('.tbbx-rateinfo',root).textContent+')'); toast((I18N[getLang('en')]||I18N.en).copied)}catch(_){toast((I18N[getLang('en')]||I18N.en).copyfail)}}
  async function shareRes(){ var L=I18N[getLang('en')]||I18N.en, text=$('.tbbx-out',root).textContent+' â€¢ '+$('.tbbx-rateinfo',root).textContent, url=w.location.href.split('#')[0]; try{ if(navigator.share){await navigator.share({title:'Currency Converter',text:text,url:url})} else {await navigator.clipboard.writeText(text+' '+url); toast(L.link)} }catch(_){} }

  function addFav(){ var f=$('.tbbx-from',root).value, t=$('.tbbx-to',root).value; var F=getFavs(); var k=f+"-"+t; if(!F.includes(k)){F.unshift(k); F=F.slice(0,10); setFavs(F); renderFavs()}}
  function renderFavs(){ var wrap=$('.tbbx-favs',root); if(!wrap) return; var F=getFavs(); wrap.innerHTML=F.map(function(k){return '<button class="tbbx-fav" data-k="'+k+'">'+esc(k)+'</button>'}).join(''); $$('.tbbx-fav',wrap).forEach(function(b){ b.addEventListener('click',function(){ var p=b.getAttribute('data-k').split('-'); $('.tbbx-from',root).value=p[0]; $('.tbbx-to',root).value=p[1]; convert() },{passive:true})}); }

  function localize(root,lang){ var L=I18N[lang]||I18N.en; $('.tbbx-cc-title',root)?.textContent=L.title;
    $$('.tbbx-label-amount',root).forEach(n=>n.textContent=L.amount); $$('.tbbx-label-from',root).forEach(n=>n.textContent=L.from); $$('.tbbx-label-to',root).forEach(n=>n.textContent=L.to);
    $('.tbbx-convert',root)?.textContent=L.convert; $('.tbbx-swap',root)?.setAttribute('title',L.swap);
    $('option[value="host"]',root)?.textContent=L.prov_host; $('option[value="frank"]',root)?.textContent=L.prov_frank; $('option[value="auto"]',root)?.textContent=L.prov_auto;
    $('.tbbx-cache-label',root)?.textContent=L.cache; $('.tbbx-invert-label',root)?.textContent=L.invert; $('.tbbx-help',root)?.textContent=L.help;
    $('.tbbx-copy',root)?.textContent=L.copy; $('.tbbx-share',root)?.textContent=L.share; $('.tbbx-favs-label',root)?.textContent=L.favs;
    $('.tbbx-addfav',root)?.textContent=L.addfav; $('.tbbx-history-btn',root)?.textContent=L.history;
  }

  function toast(msg){ var t=d.getElementById('tbbx-toast'); if(!t){ t=d.createElement('div'); t.id='tbbx-toast'; t.style.cssText='position:fixed;inset:auto 12px 12px auto;background:var(--tbbx-fg);color:var(--tbbx-bg);padding:8px 12px;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,.2);z-index:9999;font:inherit;transition:opacity .25s'; d.body.appendChild(t);} t.textContent=msg; t.style.opacity='1'; clearTimeout(t._id); t._id=setTimeout(function(){t.style.opacity='0'},1400)}
}

if('requestIdleCallback'in w){w.requestIdleCallback(initAll,{timeout:1200})} else {w.addEventListener('DOMContentLoaded',initAll,{once:true})}
}(window,document);
